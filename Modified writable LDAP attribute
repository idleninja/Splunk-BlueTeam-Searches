index=windows sourcetype="WinEventLog:Security" "A directory service object was modified" (LDAP_Display_Name="thumbnailPhoto" OR LDAP_Display_Name="pager" OR LDAP_Display_Name="mobile" OR LDAP_Display_Name="homePhone" OR LDAP_Display_Name="userSMIMECertificate" OR LDAP_Display_Name="msDS-cloudExtensionAttribute20" OR LDAP_Display_Name="msDS-cloudExtensionAttribute19" OR LDAP_Display_Name="msDS-cloudExtensionAttribute18" OR LDAP_Display_Name="msDS-cloudExtensionAttribute17" OR LDAP_Display_Name="msDS-cloudExtensionAttribute16" OR LDAP_Display_Name="msDS-cloudExtensionAttribute15" OR LDAP_Display_Name="msDS-cloudExtensionAttribute14" OR LDAP_Display_Name="msDS-cloudExtensionAttribute13" OR LDAP_Display_Name="msDS-cloudExtensionAttribute12" OR LDAP_Display_Name="msDS-cloudExtensionAttribute11" OR LDAP_Display_Name="msDS-cloudExtensionAttribute10" OR LDAP_Display_Name="msDS-cloudExtensionAttribute9" OR LDAP_Display_Name="msDS-cloudExtensionAttribute8" OR LDAP_Display_Name="msDS-cloudExtensionAttribute7" OR LDAP_Display_Name="msDS-cloudExtensionAttribute6" OR LDAP_Display_Name="msDS-cloudExtensionAttribute5" OR LDAP_Display_Name="msDS-cloudExtensionAttribute4" OR LDAP_Display_Name="msDS-cloudExtensionAttribute3" OR LDAP_Display_Name="msDS-cloudExtensionAttribute2" OR LDAP_Display_Name="msDS-cloudExtensionAttribute1" OR LDAP_Display_Name="msDS-GeoCoordinatesLongitude" OR LDAP_Display_Name="msDS-GeoCoordinatesLatitude" OR LDAP_Display_Name="msDS-GeoCoordinatesAltitude" OR LDAP_Display_Name="msPKI-CredentialRoamingTokens" OR LDAP_Display_Name="msDS-SupportedEncryptionTypes" OR LDAP_Display_Name="msPKIAccountCredentials" OR LDAP_Display_Name="msPKIDPAPIMasterKeys" OR LDAP_Display_Name="msPKIRoamingTimeStamp" OR LDAP_Display_Name="mSMQDigests" OR LDAP_Display_Name="mSMQSignCertificates" OR LDAP_Display_Name="userSharedFolderOther" OR LDAP_Display_Name="userSharedFolder" OR LDAP_Display_Name="url" OR LDAP_Display_Name="otherIpPhone" OR LDAP_Display_Name="ipPhone" OR LDAP_Display_Name="assistant" OR LDAP_Display_Name="primaryInternationalISDNNumber" OR LDAP_Display_Name="primaryTelexNumber" OR LDAP_Display_Name="otherMobile" OR LDAP_Display_Name="otherFacsimileTelephoneNumber" OR LDAP_Display_Name="userCert" OR LDAP_Display_Name="homePostalAddress" OR LDAP_Display_Name="personalTitle" OR LDAP_Display_Name="wWWHomePage" OR LDAP_Display_Name="otherHomePhone" OR LDAP_Display_Name="streetAddress" OR LDAP_Display_Name="publicDelegates" OR LDAP_Display_Name="otherPager" OR LDAP_Display_Name="info" OR LDAP_Display_Name="otherTelephone" OR LDAP_Display_Name="userCertificate" OR LDAP_Display_Name="preferredDeliveryMethod" OR LDAP_Display_Name="registeredAddress" OR LDAP_Display_Name="internationalISDNNumber" OR LDAP_Display_Name="x121Address" OR LDAP_Display_Name="facsimileTelephoneNumber" OR LDAP_Display_Name="teletexTerminalIdentifier" OR LDAP_Display_Name="telexNumber" OR LDAP_Display_Name="telephoneNumber" OR LDAP_Display_Name="physicalDeliveryOfficeName" OR LDAP_Display_Name="postOfficeBox" OR LDAP_Display_Name="postalCode" OR LDAP_Display_Name="postalAddress" OR LDAP_Display_Name="street" OR LDAP_Display_Name="st" ) 
| rex field=Message "Subject:\s+Security ID:\s+(?<admin_account>\S+)" 
| rex field=Message "Object:\s+DN:\s+(?<user_account_cn>\S+)" 
| rex field=Message "Object:\s+DN:\s+CN\=(?<user_account>[^,]+)" 
| search admin_account!="*$" AND admin_account!="service_accounts*"
| eval ignore = case(LDAP_Display_Name=="thumbnailPhoto" OR LDAP_Display_Name=="msPKIRoamingTimeStamp" OR LDAP_Display_Name=="msPKIDPAPIMasterKeys" OR LDAP_Display_Name=="userCertificate", "false", LDAP_Display_Name=="physicalDeliveryOfficeName" AND len(Value) <= 10, "true", (LDAP_Display_Name=="publicDelegates" OR LDAP_Display_Name=="info") AND like(Value, "%DC=domain,DC=tld"), "true", len(Value) < 20, "true", true(), "false") 
| where ignore=="false" 
| eval msg = "Non admin attempting to modify LDAP user attributes" 
| table _time admin_account user_account EventCodeDescription LDAP_Display_Name Value msg
